<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eye Detection</title>
    <style>
        #canvas {
            border: 1px solid black;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Eye Detection</h1>
    <input type="file" id="imageUpload" accept="image/*">
    <canvas id="canvas"></canvas>

    <script async src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script>
    <script type="text/javascript">
        document.getElementById('imageUpload').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const img = new Image();
            img.onload = function() {
                const canvas = document.getElementById('canvas');
                const ctx = canvas.getContext('2d');

                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0, img.width, img.height);

                const src = cv.imread(canvas);
                const gray = new cv.Mat();
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);

                const faceCascade = new cv.CascadeClassifier();
                const eyeCascade = new cv.CascadeClassifier();

                // Load pre-trained Haar Cascade models
                faceCascade.load('haarcascade_frontalface_default.xml');
                eyeCascade.load('haarcascade_eye.xml');

                const faces = new cv.RectVector();
                const msize = new cv.Size(0, 0);

                // Detect faces
                faceCascade.detectMultiScale(gray, faces, 1.1, 3, 0, msize, msize);

                for (let i = 0; i < faces.size(); ++i) {
                    const face = faces.get(i);
                    const faceROI = gray.roi(face);

                    // Detect eyes within the face region
                    const eyes = new cv.RectVector();
                    eyeCascade.detectMultiScale(faceROI, eyes, 1.1, 3, 0, msize, msize);

                    for (let j = 0; j < eyes.size(); ++j) {
                        const eye = eyes.get(j);
                        const center = new cv.Point(face.x + eye.x + eye.width / 2, face.y + eye.y + eye.height / 2);

                        // Draw circle around the eye
                        cv.circle(src, center, Math.round((eye.width + eye.height) * 0.25), [255, 0, 0, 255], 2);
                    }
                    faceROI.delete();
                    eyes.delete();
                }

                cv.imshow('canvas', src);
                src.delete();
                gray.delete();
                faceCascade.delete();
                eyeCascade.delete();
                faces.delete();
            };

            const reader = new FileReader();
            reader.onload = function(e) {
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    </script>
</body>
</html>
